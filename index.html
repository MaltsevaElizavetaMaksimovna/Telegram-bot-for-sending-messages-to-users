<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VK Auth</title>
</head>
<body>
  <button onclick="loginWithVK()">Войти через VK ID</button>

  <script>
    function generateCodeVerifier() {
      const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      return Array.from({ length: 64 }, () => charset[Math.floor(Math.random() * charset.length)]).join('');
    }

    function generateCodeChallenge(verifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      return crypto.subtle.digest('SHA-256', data).then(hash => {
        return btoa(String.fromCharCode(...new Uint8Array(hash)))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
      });
    }

    async function loginWithVK() {
      const code_verifier = generateCodeVerifier();
      const code_challenge = await generateCodeChallenge(code_verifier);

      const state = Math.random().toString(36).substring(2, 15);

      const redirect_uri = 'https://localhost/auth';

      try {
        const resp = await fetch('/set_verifier', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({code_verifier, state})
        });
        if (!resp.ok) throw new Error('Не удалось сохранить данные');
      } catch (err) {
        alert("Ошибка: " + err.message);
        return;
      }

      const authUrl = new URL('https://id.vk.ru/authorize');

      authUrl.searchParams.set('scope', 'vkid.personal_info,vkid.email,offline');
      authUrl.searchParams.set('client_id', '54385929');
      authUrl.searchParams.set('redirect_uri', redirect_uri);
      authUrl.searchParams.set('response_type', 'code');
      authUrl.searchParams.set('code_challenge', code_challenge);
      authUrl.searchParams.set('code_challenge_method', 'S256');
      authUrl.searchParams.set('state', state);

      window.location.href = authUrl.toString();
    }
  </script>
</body>
</html>